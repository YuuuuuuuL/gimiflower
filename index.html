<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ˜¥è¯ç´…åº•æ¥µè‡´æ’ç‰ˆå·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --a4-w: 210mm; --a4-h: 297mm; }
        * { box-sizing: border-box; }
        body { background: #1a1a1a; display: flex; flex-direction: column; align-items: center; padding: 20px; font-family: sans-serif; }
        
        .toolbar { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; width: 750px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        
        /* A4 ç´™å¼µï¼šæ”¹ç‚ºå¤§ç´…è‰²èƒŒæ™¯ */
        #a4-page {
            width: var(--a4-w); height: var(--a4-h);
            background: #e60012; /* ç¶“å…¸æ˜¥è¯ç´… */
            padding: 3mm; 
            display: flex; flex-wrap: wrap; gap: 2mm; 
            align-content: flex-start; overflow: hidden; position: relative;
        }

        .combo-row { display: flex; gap: 2mm; align-items: flex-start; }
        .v-stack { display: flex; flex-direction: column; gap: 2mm; }

        /* æ ¼å­æ¨£å¼ï¼šç™½è‰²ç´°é‚Šæ¡†æ–¹ä¾¿è¾¨è­˜ */
        .chun-lian {
            border: 0.5px solid rgba(255, 255, 255, 0.4); 
            background: rgba(255, 255, 255, 0.05);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; position: relative; flex-shrink: 0;
        }
        .chun-lian img { width: 100%; height: 100%; object-fit: contain; }

        /* å°ºå¯¸å®šç¾© */
        .s15 { width: 150mm; height: 150mm; }
        .s10 { width: 100mm; height: 100mm; }
        .s5  { width: 50mm; height: 50mm; }
        .s4  { width: 40mm; height: 40mm; }
        .long-big { width: 50mm; height: 200mm; }
        .long-small { width: 30mm; height: 120mm; }

        .btn-group { margin: 10px 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        button { padding: 8px 14px; margin: 4px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        .btn-combo { background: #d32f2f; color: white; } /* æ”¹ç‚ºæ·±ç´…æŒ‰éˆ• */
        .btn-new { background: #ff9800; color: white; }
        .btn-std { background: #4caf50; color: white; }
        .btn-save { background: #c62828; color: white; width: 100%; margin-top: 10px; font-size: 16px; }
        .label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="toolbar">
    <div class="btn-group">
        <span class="label">ğŸ§§ è³€æ­²æœ€ä½³çµ„åˆ</span>
        <button class="btn-combo" onclick="addBestCombo15()">15cm çµ„åˆ (15+5*3)</button>
        <button class="btn-combo" onclick="addBestCombo10()">10cm çµ„åˆ (10+5*4)</button>
    </div>

    <div class="btn-group">
        <span class="label">ğŸ“œ å°è¯å°ºå¯¸</span>
        <button class="btn-new" onclick="addSingle('long-big')">å¤§å°è¯ (5x20cm)</button>
        <button class="btn-new" onclick="addSingle('long-small')">å°å°è¯ (3x12cm)</button>
        <button class="btn-new" onclick="addSingle('s4')">è¿·ä½ æ–—æ–¹ (4x4cm)</button>
    </div>

    <div class="btn-group" style="border:none;">
        <span class="label">ğŸŸ§ æ¨™æº–å°ºå¯¸</span>
        <button class="btn-std" onclick="addSingle('s15')">15cm</button>
        <button class="btn-std" onclick="addSingle('s10')">10cm</button>
        <button class="btn-std" onclick="addSingle('s5')">5cm</button>
        <button onclick="document.getElementById('a4-page').innerHTML=''" style="background:#444; color:white;">æ¸…ç©º</button>
    </div>
    
    <button class="btn-save" onclick="exportImage()">ç¢ºèªä¸¦ä¸‹è¼‰ç´…åº•åˆ—å°åœ–</button>
</div>

<div id="a4-page"></div>
<input type="file" id="fInput" style="display:none" accept="image/*">

<script>
    const a4 = document.getElementById('a4-page');
    const fInput = document.getElementById('fInput');
    let targetBox = null;

    function makeBox(cls) {
        const div = document.createElement('div');
        div.className = 'chun-lian ' + cls;
        div.onclick = (e) => { e.stopPropagation(); targetBox = div; fInput.value = ''; fInput.click(); };
        return div;
    }

    function addBestCombo15() {
        const row = document.createElement('div');
        row.className = 'combo-row';
        row.appendChild(makeBox('s15'));
        const v = document.createElement('div');
        v.className = 'v-stack';
        v.appendChild(makeBox('s5')); v.appendChild(makeBox('s5')); v.appendChild(makeBox('s5'));
        row.appendChild(v);
        canFit(row);
    }

    function addBestCombo10() {
        const row = document.createElement('div');
        row.className = 'combo-row';
        row.appendChild(makeBox('s10'));
        for(let i=0; i<2; i++) {
            const v = document.createElement('div');
            v.className = 'v-stack';
            v.appendChild(makeBox('s5')); v.appendChild(makeBox('s5'));
            row.appendChild(v);
        }
        canFit(row);
    }

    function addSingle(cls) { canFit(makeBox(cls)); }

    function canFit(el) {
        a4.appendChild(el);
        if (a4.scrollHeight > a4.clientHeight + 2) {
            alert("ç©ºé–“ä¸è¶³ï¼"); a4.removeChild(el); return false;
        }
        return true;
    }

    fInput.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxDim = 1500; 
                let w = img.width, h = img.height;
                if (w > h && w > maxDim) { h *= maxDim / w; w = maxDim; }
                else if (h > maxDim) { w *= maxDim / h; h = maxDim; }
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                targetBox.innerHTML = '';
                const newImg = document.createElement('img');
                newImg.src = canvas.toDataURL('image/jpeg', 0.9);
                targetBox.appendChild(newImg);
                targetBox.style.border = "none"; // ä¸Šå‚³å¾Œç§»é™¤é‚Šæ¡†
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };

    function exportImage() {
        if (a4.children.length === 0) return alert("è«‹å…ˆæ–°å¢æ˜¥è¯");
        html2canvas(a4, { scale: 3, useCORS: true }).then(canvas => {
            const a = document.createElement('a');
            a.download = 'Red_ChunLian_A4.png';
            a.href = canvas.toDataURL('image/png');
            a.click();
        });
    }
</script>
</body>
</html>
